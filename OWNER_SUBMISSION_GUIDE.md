# Руководство по системе самостоятельного добавления объектов

## Обзор системы

Владельцы могут самостоятельно добавлять свои объекты через веб-форму без участия администратора. После модерации они автоматически получают доступ к экстранету.

## Процесс для владельца

### 1. Добавление объекта
- Владелец переходит на главную страницу сайта
- Нажимает кнопку **"Добавить объект"** (зеленая кнопка в шапке)
- Заполняет форму в 6 шагов:
  1. **О вас**: ФИО, email, телефон, Telegram
  2. **Основная информация**: название, тип, город, описание
  3. **Местоположение**: адрес, метро, парковка
  4. **Номера**: категории номеров с фото и ценами
  5. **Контакты**: телефон и Telegram для гостей
  6. **Проверка**: итоговый просмотр перед отправкой

### 2. Модерация
- Объект попадает на модерацию со статусом "Заявка владельца"
- Администратор проверяет данные
- При одобрении владелец автоматически получает email с:
  - Логином (его email)
  - Временным паролем
  - Ссылкой на экстранет

### 3. Доступ к экстранету
- Владелец входит в экстранет используя полученные данные
- Может управлять своим объектом:
  - Редактировать информацию
  - Управлять ценами
  - Продвигать в топ
  - Смотреть статистику

## Процесс для администратора

### 1. Просмотр заявок
- Заявки владельцев выделяются **синим бейджем** "Заявка владельца"
- Доступны на вкладке "Модерация" в админ-панели
- Показывается информационный блок с инструкциями

### 2. Модерация заявки

#### Быстрое одобрение:
- Кнопка **"Одобрить и отправить email"** — мгновенно одобряет и отправляет данные владельцу

#### Детальная модерация:
- Кнопка **"Отклонить с комментарием"**
- Выбор статуса: Одобрено / Отклонено / На проверке
- Опция отправки email (включена по умолчанию для одобрения)
- Обязательный комментарий при отклонении

### 3. Что проверять

✅ **Перед одобрением:**
- Корректность контактных данных владельца
- Наличие активной подписки (устанавливается через кнопку "Подписка")
- Качество фотографий и описаний
- Соответствие указанной информации

❌ **При отклонении:**
- Обязательно укажите причину в комментарии
- Владелец увидит комментарий и сможет исправить

### 4. Отправка учетных данных

**Автоматическая отправка:**
- При одобрении через кнопку "Одобрить и отправить email"
- При одобрении через диалог модерации с включенной галочкой "Отправить email"

**Письмо содержит:**
- Поздравление с одобрением
- Логин и временный пароль
- Ссылку на экстранет
- Инструкции по входу
- Рекомендацию сменить пароль

## Техническая информация

### Backend функции

**1. owner-listing-submission** (`/backend/owner-listing-submission`)
- Прием заявок от владельцев
- Автоматическое создание аккаунта владельца
- Генерация временного пароля
- Сохранение объекта со статусом `pending`

**2. send-owner-credentials** (`/backend/send-owner-credentials`)
- Отправка email с учетными данными
- Вызывается автоматически после одобрения
- Требует настройки SMTP (см. ниже)

### Настройка SMTP

Для автоматической отправки email требуются секреты:

```
SMTP_HOST      - smtp.yandex.ru или smtp.mail.ru
SMTP_PORT      - 587 (TLS) или 465 (SSL)
SMTP_USER      - ваш email (например: noreply@120minut.ru)
SMTP_PASSWORD  - пароль приложения (не основной пароль!)
```

**Получение пароля приложения:**

**Yandex:**
1. Настройки → Безопасность
2. Создать "Пароль приложения"
3. Использовать этот пароль

**Mail.ru:**
1. Настройки → Пароль и безопасность
2. Включить "Пароли внешних приложений"
3. Создать пароль для приложения

### База данных

**Таблицы:**
- `listings.created_by_owner` - флаг объектов от владельцев
- `pending_owner_credentials` - временные пароли владельцев
  - `owner_id` - ID владельца
  - `temporary_password` - временный пароль
  - `sent_at` - время отправки email

### Фронтенд компоненты

**Форма добавления:** `/src/pages/AddListing.tsx`
- 6 шаговая форма с валидацией
- Загрузка изображений
- Адаптивный дизайн

**Шаги формы:** `/src/components/listing-steps/`
- `OwnerInfoStep` - данные владельца
- `ListingBasicInfoStep` - основная информация
- `ListingLocationStep` - местоположение
- `ListingRoomsStep` - номера
- `ListingContactsStep` - контакты
- `ListingReviewStep` - проверка перед отправкой

**Диалог модерации:** `/src/components/admin/OwnerModerationDialog.tsx`
- Специальный диалог для заявок владельцев
- Опция отправки email
- Информационные блоки

## Часто задаваемые вопросы

**Q: Что если владелец не получил email?**
A: Проверьте:
1. Правильность email адреса в заявке
2. Настройки SMTP в секретах проекта
3. Папку спам у владельца
4. Логи backend функции send-owner-credentials

**Q: Можно ли отправить email повторно?**
A: Да, можно вызвать backend функцию вручную с listing_id через API

**Q: Владелец уже существует в системе?**
A: Если email уже есть в БД, новый аккаунт не создается, объект привязывается к существующему

**Q: Как владелец может сменить пароль?**
A: В экстранете в разделе настроек профиля (функционал нужно добавить отдельно)

## Логи и отладка

**Проверка логов:**
```bash
# Frontend логи (браузер)
- Откройте DevTools → Console

# Backend логи
- Админ-панель → Логи → backend/owner-listing-submission
- Админ-панель → Логи → backend/send-owner-credentials
```

**Типичные ошибки:**
- "SMTP настройки не заданы" → добавьте SMTP секреты
- "Объект не найден" → проверьте listing_id
- "Учетные данные не найдены" → владелец создан не через форму

## Поддержка

При возникновении проблем:
1. Проверьте логи backend функций
2. Убедитесь что SMTP настроен корректно
3. Проверьте статус подписки объекта
4. Свяжитесь с технической поддержкой платформы
